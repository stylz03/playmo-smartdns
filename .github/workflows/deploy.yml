name: Deploy SmartDNS

on:
  push:
    branches:
      - main
  workflow_dispatch:   # allow manual runs
  schedule:
    - cron: "0 7 * * *"   # run daily at 07:00 UTC for auto re-validation

jobs:
  terraform:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::843336589038:role/playmo-terraform-deploy
          aws-region: us-east-2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Terraform Init
        run: terraform init
        working-directory: terraform

      - name: Terraform Validate
        run: terraform validate
        working-directory: terraform

      - name: Import existing resources if they exist
        run: |
          # Get default VPC ID
          VPC_ID=$(aws ec2 describe-vpcs --filters "Name=isDefault,Values=true" --query 'Vpcs[0].VpcId' --output text --region us-east-2)
          echo "Default VPC ID: $VPC_ID"
          
          # Import Security Group if it exists
          SG_ID=$(aws ec2 describe-security-groups \
            --filters "Name=group-name,Values=playmo-smartdns-dns-only-sg" "Name=vpc-id,Values=$VPC_ID" \
            --query 'SecurityGroups[0].GroupId' --output text --region us-east-2 2>/dev/null || echo "")
          
          if [ -n "$SG_ID" ] && [ "$SG_ID" != "None" ] && [ "$SG_ID" != "" ]; then
            echo "Found existing security group: $SG_ID"
            terraform import aws_security_group.smartdns_sg $SG_ID || echo "Security group already in state or import failed"
          else
            echo "No existing security group found, will create new one"
          fi
          
          # Import IAM Role if it exists (IAM is global, no region needed)
          ROLE_NAME="playmo-smartdns-dns-only-lambda-role"
          if aws iam get-role --role-name $ROLE_NAME >/dev/null 2>&1; then
            echo "Found existing IAM role: $ROLE_NAME"
            # Check if already in state
            if terraform state show 'aws_iam_role.lambda_role[0]' >/dev/null 2>&1; then
              echo "IAM role already in Terraform state"
            else
              echo "Importing IAM role into Terraform state..."
              terraform import 'aws_iam_role.lambda_role[0]' $ROLE_NAME 2>&1 || echo "IAM role import failed"
            fi
          else
            echo "No existing IAM role found, will create new one"
          fi
          
          # Import IAM Policy if it exists
          POLICY_NAME="playmo-smartdns-dns-only-lambda-sg-policy"
          # Try multiple methods to get the policy ARN
          POLICY_ARN=$(aws iam list-policies --scope Local --query "Policies[?PolicyName=='$POLICY_NAME'].Arn" --output text 2>/dev/null | tr '\t' '\n' | head -n1 || echo "")
          
          # Alternative: get by account and policy name pattern
          if [ -z "$POLICY_ARN" ] || [ "$POLICY_ARN" == "None" ]; then
            ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text 2>/dev/null || echo "843336589038")
            POLICY_ARN="arn:aws:iam::${ACCOUNT_ID}:policy/${POLICY_NAME}"
            # Verify it exists
            if ! aws iam get-policy --policy-arn "$POLICY_ARN" >/dev/null 2>&1; then
              POLICY_ARN=""
            fi
          fi
          
          if [ -n "$POLICY_ARN" ] && [ "$POLICY_ARN" != "None" ] && [ "$POLICY_ARN" != "" ]; then
            echo "Found existing IAM policy: $POLICY_ARN"
            # Check if already in state
            if terraform state show 'aws_iam_policy.lambda_sg_policy[0]' >/dev/null 2>&1; then
              echo "IAM policy already in Terraform state"
            else
              echo "Importing IAM policy into Terraform state..."
              if terraform import 'aws_iam_policy.lambda_sg_policy[0]' "$POLICY_ARN" 2>&1; then
                echo "‚úÖ Successfully imported IAM policy"
              else
                echo "‚ö†Ô∏è IAM policy import failed, but continuing..."
              fi
            fi
            
            # Also import the policy attachment if role exists
            if aws iam get-role --role-name $ROLE_NAME >/dev/null 2>&1; then
              if terraform state show 'aws_iam_role_policy_attachment.attach_lambda_policy[0]' >/dev/null 2>&1; then
                echo "Policy attachment already in Terraform state"
              else
                echo "Importing policy attachment..."
                if terraform import 'aws_iam_role_policy_attachment.attach_lambda_policy[0]' "$ROLE_NAME/$POLICY_ARN" 2>&1; then
                  echo "‚úÖ Successfully imported policy attachment"
                else
                  echo "‚ö†Ô∏è Policy attachment import failed, but continuing..."
                fi
              fi
            fi
          else
            echo "No existing IAM policy found, will create new one"
          fi
        working-directory: terraform
        continue-on-error: true

      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: terraform
        continue-on-error: false

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan
        working-directory: terraform

      - name: Capture Terraform Outputs
        id: tf_outputs
        run: |
          echo "EC2_PUBLIC_IP=$(terraform output -raw ec2_public_ip)" >> $GITHUB_ENV
          echo "LAMBDA_URL=$(terraform output -raw lambda_function_url)" >> $GITHUB_ENV
          echo "PROJECT_NAME=$(terraform output -raw project_name)" >> $GITHUB_ENV
          echo "AWS_REGION=$(terraform output -raw aws_region)" >> $GITHUB_ENV
        working-directory: terraform

      - name: Test Lambda Whitelist
        run: |
          curl -s -X POST -H "Content-Type: application/json" \
            -d '{"ip":"102.32.16.36","proto":"udp"}' \
            "$LAMBDA_URL"

      - name: Test DNS Resolution with Guard
        run: |
          sudo apt-get update && sudo apt-get install -y dnsutils
          for domain in netflix.com disneyplus.com youtube.com; do
            echo "Testing $domain against $EC2_PUBLIC_IP..."
            result=$(dig +short $domain @$EC2_PUBLIC_IP)
            if [ -z "$result" ]; then
              echo "‚ùå DNS resolution failed for $domain"
              exit 1
            else
              echo "‚úÖ $domain resolved to $result"
            fi
          done

      - name: Notify Slack on Success
        if: success() && github.event_name != 'schedule'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"blocks\": [
              {\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"üöÄ SmartDNS Deployment Succeeded\"}},
              {\"type\": \"section\", \"fields\": [
                {\"type\": \"mrkdwn\", \"text\": \"*Project:* $PROJECT_NAME\"},
                {\"type\": \"mrkdwn\", \"text\": \"*Region:* $AWS_REGION\"},
                {\"type\": \"mrkdwn\", \"text\": \"*EC2 IP:* $EC2_PUBLIC_IP\"},
                {\"type\": \"mrkdwn\", \"text\": \"*Lambda URL:* $LAMBDA_URL\"}
              ]},
              {\"type\": \"actions\", \"elements\": [
                {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"View GitHub Run\"}, \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
              ]}
            ]
          }" \
          ${{ secrets.SLACK_SUCCESS_WEBHOOK }}

      - name: Notify Slack on Failure
        if: failure() && github.event_name != 'schedule'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"blocks\": [
              {\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"üî• SmartDNS Deployment Failed\"}},
              {\"type\": \"section\", \"fields\": [
                {\"type\": \"mrkdwn\", \"text\": \"*Project:* $PROJECT_NAME\"},
                {\"type\": \"mrkdwn\", \"text\": \"*Region:* $AWS_REGION\"}
              ]},
              {\"type\": \"actions\", \"elements\": [
                {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"View GitHub Run\"}, \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
              ]}
            ]
          }" \
          ${{ secrets.SLACK_FAILURE_WEBHOOK }}

      - name: Notify Slack Heartbeat
        if: github.event_name == 'schedule'
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{
            \"blocks\": [
              {\"type\": \"header\", \"text\": {\"type\": \"plain_text\", \"text\": \"üïí SmartDNS Daily Validation\"}},
              {\"type\": \"section\", \"fields\": [
                {\"type\": \"mrkdwn\", \"text\": \"*Project:* $PROJECT_NAME\"},
                {\"type\": \"mrkdwn\", \"text\": \"*Region:* $AWS_REGION\"},
                {\"type\": \"mrkdwn\", \"text\": \"*EC2 IP:* $EC2_PUBLIC_IP\"},
                {\"type\": \"mrkdwn\", \"text\": \"*Lambda URL:* $LAMBDA_URL\"}
              ]},
              {\"type\": \"actions\", \"elements\": [
                {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"View GitHub Run\"}, \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}
              ]}
            ]
          }" \
          ${{ secrets.SLACK_HEARTBEAT_WEBHOOK }}
